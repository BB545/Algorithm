name: LeetHub Organizer (Crash Proof)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  organize:
    runs-on: ubuntu-latest
    continue-on-error: false

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1️⃣ LeetHub 커밋 여부 판단
      - name: Check LeetHub Commit
        id: check
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B || true)"
          echo "$COMMIT_MSG"

          if [[ "$COMMIT_MSG" != *"LeetHub"* ]]; then
            echo "NOT_LEETHUB=true" >> $GITHUB_ENV
          else
            echo "NOT_LEETHUB=false" >> $GITHUB_ENV
            echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
            echo "$COMMIT_MSG" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

          exit 0

      # 2️⃣ LeetHub 아니면 그냥 성공 종료
      - name: Skip if not LeetHub
        if: env.NOT_LEETHUB == 'true'
        run: |
          echo "LeetHub 커밋 아님 → 정상 종료"
          exit 0

      # 3️⃣ 모든 000x-* 폴더 강제 이동 (절대 실패 안 함)
      - name: Force Move LeetHub Folders
        run: |
          shopt -s nullglob

          ROOT="LeetCode"
          mkdir -p "$ROOT"

          MOVED=false

          for DIR in 0[0-9][0-9][0-9]-*; do
            [ -d "$DIR" ] || continue

            echo "처리 중: $DIR"

            # 난이도 추출 (실패해도 무시)
            LEVEL="Unknown"
            if [ -f "$DIR/README.md" ]; then
              LEVEL=$(grep -oP '(?<=<h3>).*?(?=</h3>)' "$DIR/README.md" | head -n 1 || echo "Unknown")
            fi

            LEVEL="$(echo "$LEVEL" | xargs)"
            [ -z "$LEVEL" ] && LEVEL="Unknown"

            TARGET=""

            for d in "$ROOT"/*; do
              if [ -d "$d/$DIR" ]; then
                TARGET="$d/$DIR"
                break
              fi
            done

            if [ -n "$TARGET" ]; then
              echo "→ 병합: $TARGET"
              mv "$DIR"/* "$TARGET"/ || true
              rm -rf "$DIR" || true
            else
              echo "→ 이동: $ROOT/$LEVEL/$DIR"
              mkdir -p "$ROOT/$LEVEL" || true
              mv "$DIR" "$ROOT/$LEVEL/" || true
            fi

            MOVED=true
          done

          if [ "$MOVED" = false ]; then
            echo "이동할 문제 폴더 없음"
          fi

          exit 0

      # 4️⃣ 커밋 & 푸시 (변경 없으면 그냥 성공)
      - name: Commit and Push
        run: |
          git config user.name "BB545"
          git config user.email "black1016@hanmail.net"

          git add .

          if git diff --cached --quiet; then
            echo "커밋할 변경 없음"
            exit 0
          fi

          git commit -m "$COMMIT_MSG" || true
          git push || true

          exit 0
