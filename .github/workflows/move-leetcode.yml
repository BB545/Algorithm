name: LeetHub Organizer (Force Move)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1️⃣ LeetHub 커밋인지 확인
      - name: Check LeetHub Commit
        id: check
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          echo "$COMMIT_MSG"

          if [[ "$COMMIT_MSG" != *"LeetHub"* ]]; then
            echo "LeetHub 커밋 아님 → 종료"
            exit 0
          fi

          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 2️⃣ root에 남아있는 모든 000x-* 문제 폴더 강제 이동
      - name: Force Move All LeetHub Folders
        run: |
          set -e

          ROOT="LeetCode"
          MOVED=false

          mkdir -p "$ROOT"

          for DIR in 0[0-9][0-9][0-9]-*; do
            # glob 매칭 실패 시 그대로 문자열이 나오는 것 방지
            [ -d "$DIR" ] || continue

            echo "발견된 LeetHub 문제 폴더: $DIR"

            # 난이도 추출 (README 기준)
            LEVEL="Unknown"
            if [ -f "$DIR/README.md" ]; then
              TMP=$(grep -oP '(?<=<h3>).*?(?=</h3>)' "$DIR/README.md" | head -n 1 || true)
              [ -n "$TMP" ] && LEVEL="$TMP"
            fi

            LEVEL_CLEAN="$(echo "$LEVEL" | xargs)"
            [ -z "$LEVEL_CLEAN" ] && LEVEL_CLEAN="Unknown"

            DEST="$ROOT/$LEVEL_CLEAN/$DIR"

            # 이미 LeetCode 안에 있으면 병합
            FOUND=""
            if [ -d "$ROOT" ]; then
              for d in "$ROOT"/*; do
                if [ -d "$d/$DIR" ]; then
                  FOUND="$d/$DIR"
                  break
                fi
              done
            fi

            if [ -n "$FOUND" ]; then
              echo "→ 기존 폴더 발견, 병합: $FOUND"
              mv "$DIR"/* "$FOUND"/
              rm -rf "$DIR"
            else
              echo "→ 새 위치로 이동: $DEST"
              mkdir -p "$ROOT/$LEVEL_CLEAN"
              mv "$DIR" "$ROOT/$LEVEL_CLEAN/"
            fi

            MOVED=true
          done

          if [ "$MOVED" = false ]; then
            echo "이동할 LeetHub 폴더 없음"
          fi

      # 3️⃣ 커밋 & 푸시
      - name: Commit and Push
        run: |
          git config user.name "BB545"
          git config user.email "black1016@hanmail.net"

          git add .

          if git diff --cached --quiet; then
            echo "변경 사항 없음"
            exit 0
          fi

          git commit -m "${{ steps.check.outputs.commit_msg }}"
          git push
