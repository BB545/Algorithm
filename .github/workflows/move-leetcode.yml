name: LeetHub Setting

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  move:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1ï¸âƒ£ LeetHub ì»¤ë°‹ì¸ì§€ í™•ì¸
      - name: Check LeetHub Commit
        id: check
        run: |
          COMMIT_MSG="$(git log -1 --pretty=%B)"
          echo "$COMMIT_MSG"

          if [[ "$COMMIT_MSG" != *"LeetHub"* ]]; then
            echo "run=false" >> $GITHUB_OUTPUT
          else
            echo "run=true" >> $GITHUB_OUTPUT
          fi

      # LeetHub ì»¤ë°‹ ì•„ë‹ˆë©´ ì´í›„ ì „ë¶€ ìŠ¤í‚µ
      - name: Skip if not LeetHub
        if: steps.check.outputs.run == 'false'
        run: |
          echo "LeetHub ì»¤ë°‹ ì•„ë‹˜ â†’ ì¢…ë£Œ"
          exit 0

      # 2ï¸âƒ£ ì´ë™
      - name: Move All LeetHub Folders
        id: move_folders
        run: |
          shopt -s nullglob

          ROOT="LeetCode"
          mkdir -p "$ROOT"

          MOVED=false

          for DIR in 0[0-9][0-9][0-9]-*; do
            [ -d "$DIR" ] || continue

            echo "ì²˜ë¦¬ ëŒ€ìƒ: $DIR"

            LEVEL="Unknown"
            if [ -f "$DIR/README.md" ]; then
              TMP=$(grep -oP '(?<=<h3>).*?(?=</h3>)' "$DIR/README.md" | head -n 1 || true)
              [ -n "$TMP" ] && LEVEL="$TMP"
            fi

            LEVEL="$(echo "$LEVEL" | xargs)"
            [ -z "$LEVEL" ] && LEVEL="Unknown"

            FOUND=""
            for d in "$ROOT"/*; do
              if [ -d "$d/$DIR" ]; then
                FOUND="$d/$DIR"
                break
              fi
            done

            if [ -n "$FOUND" ]; then
              echo "â†’ ê¸°ì¡´ í´ë” ë³‘í•©: $FOUND"

              # ğŸ”’ íŒŒì¼ì´ ìˆì„ ë•Œë§Œ mv
              if [ "$(ls -A "$DIR")" ]; then
                mv "$DIR"/* "$FOUND"/
              fi

              rm -rf "$DIR"
            else
              echo "â†’ ìƒˆ ìœ„ì¹˜ë¡œ ì´ë™: $ROOT/$LEVEL/$DIR"
              mkdir -p "$ROOT/$LEVEL"
              mv "$DIR" "$ROOT/$LEVEL/"
            fi

            MOVED=true
          done

          echo "moved=$MOVED" >> $GITHUB_OUTPUT

      # 3ï¸âƒ£ ì‹¤ì œ ì´ë™ì´ ìˆì—ˆì„ ë•Œë§Œ ì»¤ë°‹
      - name: Commit and Push
        if: steps.move_folders.outputs.moved == 'true'
        run: |
          git config --global user.name "BB545"
          git config --global user.email "black1016@hanmail.net"

          git add .

          if git diff --cached --quiet; then
            echo "ë³€ê²½ ì‚¬í•­ ì—†ìŒ"
            exit 0
          fi

          git commit -m "chore: organize LeetHub folders"
          git push
