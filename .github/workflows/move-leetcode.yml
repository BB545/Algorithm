name: LeetHub Organizer

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  organize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      # 1️⃣ LeetHub 커밋 확인
      - name: Check LeetHub Commit
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "$COMMIT_MSG"

          if [[ "$COMMIT_MSG" != *"LeetHub"* ]]; then
            echo "LeetHub 커밋 아님 → 종료"
            exit 0
          fi

          echo "commit_msg<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 2️⃣ 변경된 문제 폴더 감지 (기존 문제 재제출 포함)
      - name: Detect Problem Folder
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "변경 파일:"
          echo "$CHANGED"

          for DIR in $(echo "$CHANGED" | awk -F/ '{print $1}' | sort -u); do
            # 이미 정리된 폴더 제외
            case "$DIR" in
              LeetCode|백준|프로그래머스|.github)
                continue
                ;;
            esac

            # LeetHub 문제 폴더 패턴 (0001-xxx)
            if [[ "$DIR" =~ ^[0-9]{4}- ]]; then
              echo "문제 폴더 감지: $DIR"
              echo "package=$DIR" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "문제 폴더 없음 → 종료"
          exit 0

      # 3️⃣ 난이도 추출 (README)
      - name: Extract Level
        id: level
        run: |
          PACKAGE="${{ steps.detect.outputs.package }}"
          README="$PACKAGE/README.md"

          if [ ! -f "$README" ]; then
            echo "level=Unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          LEVEL=$(grep -oP '(?<=<h3>).*?(?=</h3>)' "$README" | head -n 1)
          [ -z "$LEVEL" ] && LEVEL="Unknown"

          echo "level=$LEVEL" >> $GITHUB_OUTPUT

      # 4️⃣ LeetCode 폴더로 이동 / 병합
      - name: Move to LeetCode
        run: |
          PACKAGE="${{ steps.detect.outputs.package }}"
          LEVEL="${{ steps.level.outputs.level }}"
          ROOT="LeetCode"

          echo "이동 대상: $PACKAGE"
          echo "난이도: $LEVEL"

          FOUND=""

          if [ -d "$ROOT" ]; then
            for d in "$ROOT"/*; do
              if [ -d "$d/$PACKAGE" ]; then
                FOUND="$d/$PACKAGE"
                break
              fi
            done
          fi

          if [ -n "$FOUND" ]; then
            echo "기존 문제 발견 → 병합"
            mv "$PACKAGE"/* "$FOUND"/
            rm -rf "$PACKAGE"
          else
            echo "새 문제 이동"
            mkdir -p "$ROOT/$LEVEL"
            mv "$PACKAGE" "$ROOT/$LEVEL/"
          fi

      # 5️⃣ 커밋 & 푸시
      - name: Commit and Push
        run: |
          git config user.name "YOUR_GITHUB_NAME"
          git config user.email "YOUR_EMAIL@example.com"

          git add .
          git commit -m "${{ steps.check.outputs.commit_msg }}" || echo "변경 없음"
          git push
